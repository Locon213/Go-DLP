name: Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  GO_VERSION: '1.25'
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          go mod download
          cd frontend && npm install

      - name: Run Go tests
        run: go test -v ./...

      - name: Upload coverage
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  build-windows-amd64:
    name: Build Windows amd64
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          go mod download
          cd frontend && npm install

      - name: Build Windows amd64
        run: |
          cd frontend && npm run build
          cd ..
          $version = (Get-Content version.txt -ErrorAction SilentlyContinue) -replace 'v',''
          if (-not $version) { $version = "dev" }
          go build -o "Go-DLP_windows_amd64.exe" -ldflags "-s -w -X main.version=$version" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Go-DLP_windows_amd64
          path: Go-DLP_windows_amd64.exe

  build-windows-arm64:
    name: Build Windows arm64
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          go mod download
          cd frontend && npm install

      - name: Build Windows arm64
        run: |
          cd frontend && npm run build
          cd ..
          $version = (Get-Content version.txt -ErrorAction SilentlyContinue) -replace 'v',''
          if (-not $version) { $version = "dev" }
          $env:GOARCH = "arm64"
          go build -o "Go-DLP_windows_arm64.exe" -ldflags "-s -w -X main.version=$version" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Go-DLP_windows_arm64
          path: Go-DLP_windows_arm64.exe

  build-linux-amd64:
    name: Build Linux amd64
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          go mod download
          cd frontend && npm install

      - name: Build Linux amd64
        run: |
          cd frontend && npm run build
          cd ..
          version=$(cat version.txt 2>/dev/null | sed 's/v//' || echo "dev")
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o "Go-DLP_linux_amd64" -ldflags "-s -w -X main.version=$version" .

      - name: Create Debian package
        run: |
          version=$(cat version.txt 2>/dev/null | sed 's/v//' || echo "dev")
          mkdir -p Go-DLP_amd64/usr/bin
          mkdir -p Go-DLP_amd64/usr/share/applications
          mkdir -p Go-DLP_amd64/usr/share/icons/hicolor/256x256/apps
          cp Go-DLP_linux_amd64 Go-DLP_amd64/usr/bin/
          
          cat > Go-DLP_amd64/usr/share/applications/go-dlp.desktop <<EOF
[Desktop Entry]
Name=Go-DLP
Comment=Modern yt-dlp Desktop Client
Exec=/usr/bin/Go-DLP
Icon=go-dlp
Terminal=false
Type=Application
Categories=Network;Video;
EOF
          
          cp frontend/src/assets/icon.png Go-DLP_amd64/usr/share/icons/hicolor/256x256/apps/go-dlp.png 2>/dev/null || true
          
          cd Go-DLP_amd64 && find . -type f -exec chmod 644 {} \; && find . -type d -exec chmod 755 {} \;
          dpkg-deb --build Go-DLP_amd64 ../go-dlp_${version}_amd64.deb

      - name: Create RPM package
        run: |
          version=$(cat version.txt 2>/dev/null | sed 's/v//' || echo "dev")
          mkdir -p rpmbuild/BUILDROOT
          mkdir -p rpmbuild/BUILD
          mkdir -p rpmbuild/RPMS
          mkdir -p rpmbuild/SOURCES
          mkdir -p rpmbuild/SPECS
          mkdir -p rpmbuild/SRPMS
          
          cp Go-DLP_linux_amd64 rpmbuild/BUILDROOT/Go-DLP-$version-1.x86_64/usr/bin/ 2>/dev/null || \
          cp Go-DLP_linux_amd64 /tmp/usr/bin/ 2>/dev/null || true
          
          cat > go-dlp.spec <<EOF
Name: go-dlp
Version: $version
Release: 1%{?dist}
Summary: Modern yt-dlp Desktop Client
License: GPLv3
URL: https://github.com/Locon213/Go-DLP
Source0: %{name}-%{version}.tar.gz

%description
Go-DLP is a powerful, cross-platform desktop application for downloading videos from YouTube and 1000+ other platforms.

%install
mkdir -p %{buildroot}/usr/bin
cp %{_builddir}/Go-DLP_linux_amd64 %{buildroot}/usr/bin/Go-DLP

%files
/usr/bin/Go-DLP

%changelog
* $(date '+%a %b %d %Y') Go-DLP <support@go-dlp.app> - $version-1
- Initial package
EOF
          
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb go-dlp.spec

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Go-DLP_linux_amd64
          path: |
            Go-DLP_linux_amd64
            go-dlp_*_amd64.deb

  build-linux-arm64:
    name: Build Linux arm64
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          go mod download
          cd frontend && npm install

      - name: Build Linux arm64
        run: |
          cd frontend && npm run build
          cd ..
          version=$(cat version.txt 2>/dev/null | sed 's/v//' || echo "dev")
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -o "Go-DLP_linux_arm64" -ldflags "-s -w -X main.version=$version" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Go-DLP_linux_arm64
          path: Go-DLP_linux_arm64

  build-macos-amd64:
    name: Build macOS amd64
    runs-on: macos-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          go mod download
          cd frontend && npm install

      - name: Build macOS amd64
        run: |
          cd frontend && npm run build
          cd ..
          version=$(cat version.txt 2>/dev/null | sed 's/v//' || echo "dev")
          export GOARCH=amd64
          go build -o "Go-DLP_darwin_amd64" -ldflags "-s -w -X main.version=$version" .

      - name: Create dmg (optional)
        if: false
        run: |
          echo "DMG creation skipped - use zip instead"
          zip -r Go-DLP_darwin_amd64.zip Go-DLP_darwin_amd64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Go-DLP_macos_amd64
          path: Go-DLP_darwin_amd64

  build-macos-arm64:
    name: Build macOS arm64
    runs-on: macos-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          go mod download
          cd frontend && npm install

      - name: Build macOS arm64
        run: |
          cd frontend && npm run build
          cd ..
          version=$(cat version.txt 2>/dev/null | sed 's/v//' || echo "dev")
          export GOARCH=arm64
          go build -o "Go-DLP_darwin_arm64" -ldflags "-s -w -X main.version=$version" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Go-DLP_macos_arm64
          path: Go-DLP_darwin_arm64
